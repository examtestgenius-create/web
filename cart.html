<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StudyHub | Checkout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/style.css?v=20260128" />

  <!-- Fallback: ensure cfg exists even if /assets/app.js fails to load -->
  <script>
    (function () {
      if (!window.cfg) {
        var BASE = 'https://script.google.com/macros/s/AKfycbwLzazM5zV41rFJ4d5NzZubstnUB-AYdfriqd9IKjb3ZoS_MmwNrnnR8c93ci5-HkST/exec';
        window.cfg = {
          catalogEndpoint: BASE + '?action=catalog',
          signEndpoint:    BASE + '?action=sign',
          notifyEndpoint:  BASE + '?action=itn',
          currency:        'ZAR',
          siteHost:        (typeof location !== 'undefined' ? location.hostname : 'examtestpaper.co.za')
        };
      }
    })();
  </script>
  <!-- Main config -->
  <script src="/assets/app.js?v=20260128"></script>
</head>
<body data-page="cart">
<header class="header">
  <div class="container">
    <div class="nav">
      <a class="brand" href="index.html"><span class="brand-badge">SH</span> <span>StudyHub</span></a>
      <nav class="links">
        <a class="link" href="index.html">Home</a>
        <a class="link" href="catalog.html">Browse Packs</a>
        <a class="link" href="free.html">Free Resources</a>
        <a class="link" href="contact.html">Contact</a>
        <a class="btn btn-secondary" href="cart.html">Cart <span data-cart-badge style="display:none;place-items:center;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:var(--brand);color:#fff;font-size:12px;font-weight:800;margin-left:6px"></span></a>
      </nav>
    </div>
  </div>
</header>

<section class="section">
  <div class="container">
    <h2>Checkout</h2>
    <div class="muted">PayFast checkout integration is configured in the backend; WhatsApp checkout is available as a fallback.</div>

    <div class="grid" style="grid-template-columns: 1.2fr .8fr;gap:14px">
      <div>
        <div id="cartList" class="grid"></div>
      </div>
      <div>
        <div class="card">
          <h3>Buyer Details</h3>
          <label class="muted" for="buyerEmail">Email address</label>
          <input id="buyerEmail" type="email" placeholder="you@example.com" style="width:100%;margin-top:6px" />

          <div style="margin-top:12px">
            <label style="display:flex;gap:10px;align-items:flex-start">
              <input type="checkbox" id="agree" />
              <span class="muted">I agree to the <a href="legal/terms.html" style="text-decoration:underline">Terms &amp; Conditions</a> and understand this is a digital product.</span>
            </label>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:14px">
            <div>
              <div class="muted">Total</div>
              <div class="price" id="cartTotal" style="margin:2px 0 0">R0</div>
            </div>
          </div>

          <div class="actions" style="margin-top:10px">
            <button class="btn btn-primary" id="payfastBtn">Pay with PayFast</button>
            <button class="btn btn-success" id="whatsappCheckout">WhatsApp Checkout</button>
          </div>

          <div class="muted" style="margin-top:10px;font-size:13px">
            PayFast button wiring is provided in the Apps Script and README. Once ITN is verified, downloads are emailed automatically.
          </div>
        </div>
      </div>
    </div>

  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.getElementById('payfastBtn');

    btn.addEventListener('click', () => {
      const agree = document.getElementById('agree');
      if (!agree.checked) {
        alert('Please accept the Terms & Conditions to continue.');
        return;
      }

      // Read cart
      const cart = JSON.parse(localStorage.getItem('studyhub_cart') || '[]');

      // Single-pack checkout for PayFast for now
      if (cart.length !== 1) {
        alert('PayFast checkout supports one pack at a time. Please checkout packs separately or use WhatsApp checkout.');
        return;
      }

      const item = cart[0];

      // Buyer info
      const email = (document.getElementById('buyerEmail')?.value || '').trim();
      const name  = (document.getElementById('fullName')?.value || '').trim();      // optional
      const phone = (document.getElementById('phoneNumber')?.value || '').trim();   // optional

      // cfg must exist
      if (!window.cfg || !cfg.catalogEndpoint) {
        alert('Missing cfg.catalogEndpoint. Set it in /assets/app.js to your Apps Script Web App URL.');
        return;
      }

      // Return and cancel pages
      const returnUrl = window.location.origin + '/success.html';
      const cancelUrl = window.location.origin + '/cancel.html';

      // Redirect to Apps Script (use real & separators)
      const base = cfg.catalogEndpoint;
      const sep  = base.includes('?') ? '&' : '?';
      const url =
        base + sep +
        'action=pay' +
        '&sku=' + encodeURIComponent(item.sku) +
        '&email=' + encodeURIComponent(email) +
        '&name=' + encodeURIComponent(name) +
        '&phone=' + encodeURIComponent(phone) +
        '&return_url=' + encodeURIComponent(returnUrl) +
        '&cancel_url=' + encodeURIComponent(cancelUrl);

      window.location.href = url;
    });
  });
</script>

<footer class="footer">
  <div class="container">
    <div class="footer-inner">
      <div class="legal">
        <a href="legal/terms.html">Terms &amp; Conditions</a>
        <a href="legal/privacy.html">Privacy Policy</a>
        <a href="legal/refunds.html">Refund Policy</a>
        <a href="legal/disclaimer.html">Copyright &amp; Disclaimer</a>
      </div>
      <div class="muted">© 2026 StudyHub • examtestpaper.co.za</div>
    </div>
  </div>
</footer>
</body>
</html>
