/**
 * PayFast ITN receiver (Google Apps Script Web App)
 *
 * Deploy as Web App and use the /exec URL as notify_url in PayFast.
 */
const CFG = {
  SUPPORT_EMAIL: "examtestgenius@gmail.com",
  PASSPHRASE: "YOUR_PAYFAST_PASSPHRASE", // set to "" if you didn't enable passphrase in PayFast settings

  // TODO: Replace with real mapping for each product/SKU
  DEFAULT_LINKS: [
    "https://drive.google.com/your-link-1",
    "https://drive.google.com/your-link-2"
  ]
};

function doPost(e) {
  try {
    const p = (e && e.parameter) ? e.parameter : {};

    if (!validateSignature(p, CFG.PASSPHRASE)) {
      return ContentService.createTextOutput("Invalid signature")
        .setMimeType(ContentService.MimeType.TEXT);
    }

    const status = (p.payment_status || "").toUpperCase();
    if (status !== "COMPLETE") {
      return ContentService.createTextOutput("OK")
        .setMimeType(ContentService.MimeType.TEXT);
    }

    const buyerEmail = p.email_address || "";
    const waNumber   = p.custom_str1 || "";
    const itemName   = p.item_name || "";
    const amount     = p.amount_gross || p.amount || "";

    const links = buildLinks(itemName, p) || CFG.DEFAULT_LINKS;

    const subjectBuyer = `Your ExamTestGenius download links: ${itemName}`;
    const bodyBuyer = `Thank you for your payment!\n\nItem: ${itemName}\nAmount: ${amount}\n\nDownload links:\n${links.join("\n")}\n\nSupport: ${CFG.SUPPORT_EMAIL}`;
    if (buyerEmail) MailApp.sendEmail(buyerEmail, subjectBuyer, bodyBuyer);

    const subjectAdmin = `New paid order: ${itemName}`;
    const bodyAdmin = `Payment COMPLETE\n\nItem: ${itemName}\nAmount: ${amount}\nBuyer: ${buyerEmail}\nWhatsApp: ${waNumber}\n\nLinks:\n${links.join("\n")}\n\nRaw payload:\n${JSON.stringify(p, null, 2)}`;
    MailApp.sendEmail(CFG.SUPPORT_EMAIL, subjectAdmin, bodyAdmin);

    return ContentService.createTextOutput("OK")
      .setMimeType(ContentService.MimeType.TEXT);

  } catch (err) {
    console.error(err);
    return ContentService.createTextOutput("OK")
      .setMimeType(ContentService.MimeType.TEXT);
  }
}

function validateSignature(params, passphrase) {
  if (!params || !params.signature) return false;

  const signature = (params.signature || "").toLowerCase();

  const keys = Object.keys(params)
    .filter(k => k !== "signature" && params[k] !== undefined && params[k] !== null && String(params[k]).length > 0)
    .sort();

  const encoded = keys
    .map(k => `${k}=${encodeURIComponent(String(params[k]).trim())}`)
    .join("&");

  const withPass = (passphrase && passphrase.trim())
    ? `${encoded}&passphrase=${encodeURIComponent(passphrase.trim())}`
    : encoded;

  const digest = Utilities.computeDigest(Utilities.DigestAlgorithm.MD5, withPass)
    .map(b => (b + 256).toString(16).slice(-2))
    .join("");

  return digest === signature;
}

function buildLinks(itemName, params) {
  // TODO: Map itemName or SKU -> file links
  // Example:
  // if (params.item_name.includes('G12-Maths')) return ['https://drive.google.com/...'];
  return null;
}
